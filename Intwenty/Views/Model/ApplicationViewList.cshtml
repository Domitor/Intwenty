@model ApplicationModel

@await Html.PartialAsync("_Modals")

<div id="app">
    <div>
        <br />
        <br />

        <div class="card">
            <div class="card-header"><h2>Manage UI</h2></div>
            <div class="card-body">
                Create and manage views for application <b>@Model.Application.Title</b>
                <br />
                First you define one or more views and then you create and connect user interfaces to the views. Views can share user interfaces among them. For example a view used to create entities may share a user interface with a view to edit an entity.
            </div>
        </div>

        <br />
        <br />

        <button class="btn btn-primary" v-on:click="openCreateViewDlg()"><span class="fa fa-plus"></span> New View</button>

        <br />
        <br />

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th style="width:5%"></th>
                    <th style="width:5%"></th>
                    <th style="width:23%">View</th>
                    <th style="width:42%">UI</th>
                    <th style="width:25%">Functions</th>

                </tr>
            </thead>
            <tr v-for="item in datalist">
                <td><a href="#" role="button" class="btn btn-sm btn-danger" v-on:click="deleteView(item)"><i class="fa fa-trash"></i></a></td>
                <td><a href="#" role="button" class="btn btn-sm btn-secondary" v-on:click="openEditViewDlg(item)"><i class="fa fa-edit"></i></a></td>
                <td>
                    <b>Title</b>
                    <br />
                    {{item.title}}
                    <br />
                    <br />
                    <b>Path</b>
                    <br />
                    {{item.path}}
                </td>

                <td>
                    <a href="#" role="button" class="btn btn-sm btn-primary" v-on:click="openCreateUIDlg(item)"><i class="fa fa-plus"></i> Add UI</a>
                    <hr />
                    <table class="table table-borderless">
                        <tr v-for="ui in item.userInterface">
                            <td style="width:10%"><a href="#" role="button" class="btn btn-sm btn-danger" v-on:click="deleteUI(ui)"><i class="fa fa-trash"></i></a></td>
                            <td style="width:30%" v-if="ui.isMetaTypeInputInterface"><a v-bind:href="'/Model/UserInterfaceInputDesign/@Model.Application.Id/' + ui.metaCode" role="button" class="btn btn-sm btn-secondary"><i class="fa fa-edit"></i> Design</a></td>
                            <td style="width:30%" v-if="ui.isMetaTypeListInterface"><a v-bind:href="'/Model/UserInterfaceListDesign/@Model.Application.Id/' + ui.metaCode" role="button" class="btn btn-sm btn-secondary"><i class="fa fa-edit"></i> Design</a></td>
                            <td style="width:60%">{{ui.description}}</td>
                        </tr>
                    </table>
                </td>
                <td>
                    <a href="#" role="button" class="btn btn-sm btn-primary" v-on:click="openAddFunctionDlg(item)"><i class="fa fa-plus"></i> Add Function</a>
                    <hr />
                    <table class="table table-borderless">
                        <tr v-for="func in item.functions">
                            <td style="width:10%"><a href="#" role="button" class="btn btn-sm btn-danger" v-on:click="deleteFunction(func)"><i class="fa fa-trash"></i></a></td>
                            <td style="width:10%"><a href="#" role="button" class="btn btn-sm btn-secondary" v-on:click="openEditFunctionDlg(func)"><i class="fa fa-edit"></i></a></td>
                            <td style="width:80%">{{func.title}}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>

    </div>


    <div class="modal" id="create_app_view_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="yesno_dlg_modal_hdr" class="modal-title">Create Application View</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label">Title<span style="color: red"> *</span></label>
                        <input id="viewtitle" type="text" class="form-control form-control-sm" v-model="model.title" />
                    </div>

                    <div class="form-group">
                        <label class="control-label">Path<span style="color: red"> *</span></label>
                        <input id="viewpath" type="text" class="form-control form-control-sm" v-model="model.path" />
                    </div>

                    <input type="checkbox" v-model="model.isPrimary" /> Is Primary
                    <br />
                    <input type="checkbox"  v-model="model.isPublic" /> Is Public

                </div>
                <div class="modal-footer">
                    <button id="create_app_view_modal_yesbtn" type="button" class="btn btn-sm btn-primary" data-dismiss="modal" :disabled="(model.title=='' || model.path=='')">Save</button>
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="create_ui_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="yesno_dlg_modal_hdr" class="modal-title">Create UI</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <input type="radio" name="createmethod" v-model="uisettings.method" value="new" /> New UI
                    <input type="radio" name="createmethod" v-model="uisettings.method" value="reuse" /> Reuse UI from other view
                    <br />
                    <br />
                    <div v-if="uisettings.method=='new'">
                        <div class="form-group">
                            <label class="control-label">UI Type<span style="color: red"> *</span></label>
                            <select class="form-control form-control-sm" v-model="uisettings.uiType">
                                <option value="1">List UI</option>
                                <option value="2">Input UI</option>
                            </select>
                        </div>
                        <br />
                        <div class="form-group">
                            <label class="control-label">Data Table<span style="color: red"> *</span></label>
                            <select class="form-control form-control-sm" v-model="uisettings.dataTableMetaCode">
                                <option v-for="item in datatables" v-bind:value="item.metaCode">{{item.dbName}}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" v-if="uisettings.method=='reuse'">
                        <label class="control-label">Select Current UI<span style="color: red"> *</span></label>
                        <select class="form-control form-control-sm" v-model="uisettings.metaCode">
                            <option v-for="item in currentuilist" v-bind:value="item.metaCode">{{item.description}}</option>
                        </select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="create_ui_modal_yesbtn" type="button" class="btn btn-sm btn-primary" data-dismiss="modal" :disabled="!canCreateUI()">Ok</button>
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="create_edit_function_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="yesno_dlg_modal_hdr" class="modal-title">{{functionsettings.dlgHeader}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="alert alert-primary" v-if="functionsettings.functionType!=''">{{getFunctionDescription()}}</div>
                    <div class="form-group">
                        <label class="control-label">Function Type<span style="color: red"> *</span></label>
                        <select class="form-control form-control-sm" v-model="functionsettings.functionType" :disabled="functionsettings.id>0">
                            <option v-for="item in functions" v-bind:value="item.metaCode">{{item.title}}</option>
                        </select>
                    </div>


                    <div class="form-group">
                        <label class="control-label">Data Table<span style="color: red"> *</span></label>
                        <select class="form-control form-control-sm" v-model="functionsettings.dataTableMetaCode" :disabled="functionsettings.id>0">
                            <option v-for="item in datatables" v-bind:value="item.metaCode">{{item.dbName}}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="control-label">Button Text<span style="color: red"> *</span></label>
                        <input id="functitle" type="text" class="form-control form-control-sm" v-model="functionsettings.title" />
                    </div>


                    <div class="form-group" v-if="functionHasPath()">
                        <label class="control-label">Path</label>
                        <input id="funcpath" type="text" class="form-control form-control-sm" v-model="functionsettings.path" />
                    </div>

                </div>

                <div class="modal-footer">
                    <button id="create_edit_function_modal_yesbtn" type="button" class="btn btn-sm btn-primary" data-dismiss="modal">Ok</button>
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="delete_ui_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="yesno_dlg_modal_hdr" class="modal-title">Delete UI ?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>This userinterface is used in more than one view. Would you like to delete it just for this view or from all views ?</p>
                </div>
                <div class="modal-footer">
                    <button id="delete_ui_modal_one" type="button" class="btn btn-sm btn-primary" data-dismiss="modal">Only this</button>
                    <button id="delete_ui_modal_all" type="button" class="btn btn-sm btn-primary" data-dismiss="modal">All</button>
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

</div>


@section Scripts
{

    <script>

        var app = new Vue({
            el: '#app',
            data: {
                datalist: []
                ,model: {}
                ,uisettings: {}
                ,currentuilist: []
                ,functionsettings: {}
            },
            methods:
            {
                getFunctionDescription: function () {
                    var context = this;

                    if (context.functionsettings.functionType == 'CREATE')
                        return "Adds a button to the view that navigates the user to the application's create view. Be sure to set the [path] to point at the view used to create entities";
                    if (context.functionsettings.functionType == 'EDIT')
                        return "Adds a button to the view that navigates the user to the application's edit view. Be sure to set the [path] to point at the view used to edit entities";
                    if (context.functionsettings.functionType == 'NAVIGATE')
                        return "Adds a button to the view that navigates the user to the [path]";
                    if (context.functionsettings.functionType == 'EXPORT')
                        return "Adds a button to the view that exports data to ms excel";
                    if (context.functionsettings.functionType == 'SAVE')
                        return "Adds a button to the view that triggers the save operation in the function table";
                    if (context.functionsettings.functionType == 'DELETE')
                        return "Adds a button to the view that triggers a delete operation in the function table";


                    return "";
                },
                functionHasPath: function () {
                    var context = this;

                    if (context.functionsettings.functionType == 'CREATE')
                        return true;
                    if (context.functionsettings.functionType == 'EDIT')
                        return true;
                    if (context.functionsettings.functionType == 'NAVIGATE')
                        return true;


                    return false;
                },
                openAddFunctionDlg: function (item)
                {
                    var context = this;

                    context.functionsettings = { id: 0, applicationId:@Model.Application.Id, viewMetaCode: item.metaCode, dlgHeader: "Add Function", functionType: "", path: "", title: "", dataTableMetaCode:"", metaCode:"" };

                    var yesfunc = function ()
                    {
                       var baseurl = '@Url.Content("~/Model/API/")';
                       var endpointurl = baseurl + "CreateFunction";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(context.functionsettings),
                            success: function (response)
                            {
                                context.datalist = response;
                            },
                            error: function (response)
                            {
                                raiseErrorModal(response.responseJSON);
                            }
                        });

                    }


                    $('#create_edit_function_modal_yesbtn').off('click', yesfunc);
                    $('#create_edit_function_modal_yesbtn').off().on('click', yesfunc);
                    $("#create_edit_function_modal").modal();


                },
                openEditFunctionDlg: function (item)
                {
                    var context = this;

                    context.functionsettings = { id: item.id, applicationId:@Model.Application.Id, viewMetaCode: item.viewMetaCode, dlgHeader: "Edit Function", functionType: item.metaType, path: item.path, title: item.title, dataTableMetaCode: item.dataTableMetaCode, metaCode: item.metaCode };

                    var yesfunc = function ()
                    {
                         var baseurl = '@Url.Content("~/Model/API/")';
                       var endpointurl = baseurl + "EditFunction";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(context.functionsettings),
                            success: function (response)
                            {
                                context.datalist = response;
                            },
                            error: function (response)
                            {
                                raiseErrorModal(response.responseJSON);
                            }
                        });

                    }


                    $('#create_edit_function_modal_yesbtn').off('click', yesfunc);
                    $('#create_edit_function_modal_yesbtn').off().on('click', yesfunc);
                    $("#create_edit_function_modal").modal();


                },
                deleteFunction: function (item)
                {
                    var context = this;

                    var yesfunc = function ()
                    {
                         var senddata = { id:item.id, applicationId:@Model.Application.Id, viewMetaCode: item.viewMetaCode, metaCode: item.metaCode };
                        var baseurl = '@Url.Content("~/Model/API/")';
                        var endpointurl = baseurl + "DeleteFunction";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(senddata),
                            success: function (response) {
                                context.datalist = response;
                            },
                            error: function (response) {
                                raiseErrorModal(response.responseJSON);
                            }
                         });
                    }

                    raiseYesNoModal("Delete function ?", "The function will be removed from the view, continue ?", yesfunc);


                },
                canCreateUI: function ()
                {
                    var context = this;

                    if (context.uisettings.method == '')
                        return false;
                    if (context.uisettings.method == 'new' && context.uisettings.uiType=="0")
                        return false;
                    if (context.uisettings.method == 'new' && context.uisettings.dataTableMetaCode=='')
                        return false;
                    if (context.uisettings.method == 'reuse' && context.uisettings.metaCode=='')
                        return false;

                    return true;
                },
                openCreateUIDlg: function (item)
                {

                    var context = this;

                    context.uisettings = { applicationId:@Model.Application.Id, viewMetaCode: item.metaCode, method: "new", uiType: "0", dataTableMetaCode: "", metaCode:"" };
                    context.currentuilist = context.getCurrentUIList(item);

                    var yesfunc = function ()
                    {
                        var senddata = context.uisettings;

                       var baseurl = '@Url.Content("~/Model/API/")';
                        var endpointurl = baseurl + "CreateUserinterface";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(senddata),
                            success: function (response)
                            {
                                context.datalist = response;
                            },
                            error: function (response)
                            {
                                raiseErrorModal(response.responseJSON);
                            }
                        });

                    }


                    $('#create_ui_modal_yesbtn').off('click', yesfunc);
                    $('#create_ui_modal_yesbtn').off().on('click', yesfunc);
                    $("#create_ui_modal").modal();

                },
                openCreateViewDlg: function ()
                {
                    var context = this;

                    context.model = { id:0, applicationId:@Model.Application.Id, metaCode: "", path: "", title: "", isPublic: false, isPrimary: false};

                    var yesfunc = function ()
                    {

                       var baseurl = '@Url.Content("~/Model/API/")';
                       var endpointurl = baseurl + "CreateApplicationView";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(context.model),
                            success: function (response)
                            {
                                context.datalist = response;
                            },
                            error: function (response)
                            {
                                raiseErrorModal(response.responseJSON);
                            }
                        });
                    }


                    $('#create_app_view_modal_yesbtn').off('click', yesfunc);
                    $('#create_app_view_modal_yesbtn').off().on('click', yesfunc);
                    $("#create_app_view_modal").modal();


                },
                openEditViewDlg: function (item)
                {
                    var context = this;

                    context.model = { id: item.id, applicationId:@Model.Application.Id, metaCode: item.metaCode, path: item.path, title: item.title, isPublic: item.isPublic, isPrimary: item.isPrimary };

                    var yesfunc = function ()
                    {

                       var baseurl = '@Url.Content("~/Model/API/")';
                       var endpointurl = baseurl + "EditApplicationView";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(context.model),
                            success: function (response)
                            {
                                context.datalist = response;
                            },
                            error: function (response)
                            {
                                raiseErrorModal(response.responseJSON);
                            }
                        });
                    }


                    $('#create_app_view_modal_yesbtn').off('click', yesfunc);
                    $('#create_app_view_modal_yesbtn').off().on('click', yesfunc);
                    $("#create_app_view_modal").modal();


                },
                getList: function ()
                {
                    var context = this;
                    var baseurl = '@Url.Content("~/Model/API/")';
                    var endpointurl = baseurl + "GetApplicationViews/@Model.Application.Id";
                    $.get(endpointurl, function (response)
                    {
                        context.datalist = response;
                    });
                },
                deleteUI: function (item)
                {
                    var context = this;
                    var existsonmultiple = false;
                    for (var i = 0; i < context.datalist.length; i++)
                    {
                        var view = context.datalist[i];
                        for (var z = 0; z < view.userInterface.length; z++)
                        {
                            var ui = view.userInterface[z];
                            if (ui.metaCode == item.metaCode && ui.id != item.id)
                                existsonmultiple = true;
                        }
                    }

                    var deleteone = function ()
                    {

                        var baseurl = '@Url.Content("~/Model/API/")';
                        var endpointurl = baseurl + "DeleteUserinterface";
                        var senddata = {  applicationId:@Model.Application.Id, method: "ONE", viewMetaCode: item.viewMetaCode, metaCode:item.metaCode };

                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(senddata),
                            success: function (response) {
                                context.datalist = response;
                            },
                            error: function (response) {
                                raiseErrorModal(response.responseJSON);
                            }
                         });

                    };

                    var deleteall = function ()
                    {

                        var baseurl = '@Url.Content("~/Model/API/")';
                        var endpointurl = baseurl + "DeleteUserinterface";
                        var senddata = {  applicationId:@Model.Application.Id, method: "ALL", viewMetaCode: item.viewMetaCode, metaCode: item.metaCode };

                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(senddata),
                            success: function (response) {
                                context.datalist = response;
                            },
                            error: function (response) {
                                raiseErrorModal(response.responseJSON);
                            }
                        });

                    };

                    if (existsonmultiple) {
                        $('#delete_ui_modal_one').off('click', deleteone);
                        $('#delete_ui_modal_one').off().on('click', deleteone);
                        $('#delete_ui_modal_all').off('click', deleteall);
                        $('#delete_ui_modal_all').off().on('click', deleteall);
                        $("#delete_ui_modal").modal();
                    } else {

                        raiseYesNoModal("Delete UI ?", "This will delete the userinterface and can not be undone, continue ?", deleteone);
                    }

                },
                deleteView: function (item)
                {
                    var context = this;

                    var yesfunc = function ()
                    {


                        var baseurl = '@Url.Content("~/Model/API/")';
                        var endpointurl = baseurl + "DeleteApplicationView";


                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(item),
                            success: function (response) {
                                context.datalist = response;
                            },
                            error: function (response) {
                                raiseErrorModal(response.responseJSON);
                            }
                         });
                    }

                    raiseYesNoModal("Delete application view ?", "This will delete the view and can not be undone, continue ?", yesfunc);


                },
                getCurrentUIList: function (item)
                {
                    var context = this;
                    var res = [];

                    for (var i = 0; i < context.datalist.length; i++)
                    {
                        var view = context.datalist[i];
                        for (var z = 0; z < view.userInterface.length; z++) {
                            var ui = view.userInterface[z];
                            if (ui.viewMetaCode != item.metaCode)
                            {
                                var exists = false;
                                for (var y = 0; y < res.length; y++)
                                {
                                    var current = res[y];
                                    if (ui.metaCode == current.metaCode)
                                    {
                                        exists = true;
                                    }

                                }
                                if (!exists)
                                    res.push(ui);

                            }
                        }
                    }

                    return res;
                }
            },
            computed: {

                datatables: function ()
                {
                    var res = [{ dbName: "@Model.Application.DbName", metaCode: "@Model.Application.MetaCode" }];
                    @foreach (var t in Model.DataStructure.Where(p => p.IsMetaTypeDataTable))
                    {
                        <text>res.push({ dbName: "@t.DbName", metaCode: "@t.MetaCode" });</text>
                    }

                    return res;
                },
                functions: function ()
                {
                    var res = [];
                    res.push({ title: "Create", metaCode: "CREATE" });
                    res.push({ title: "Edit", metaCode: "EDIT" });
                    res.push({ title: "Delete", metaCode: "DELETE" });
                    res.push({ title: "Navigate", metaCode: "NAVIGATE" });
                    res.push({ title: "Save", metaCode: "SAVE" });
                    res.push({ title: "Export", metaCode: "EXPORT" });
                    return res;
                }

            },
            mounted: function ()
            {

                var context = this;
                context.getList();

            }
        });
    </script>


}