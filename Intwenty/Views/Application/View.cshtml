@model Intwenty.Model.ViewModel

@{

    var mainDbName = Model.ApplicationInfo.DbName;
    var applicationId = Model.ApplicationInfo.Id;
    var applicationViewId = Model.Id;
    int instanceid = (int)ViewBag.Id;
    var aftersaveaction = string.Empty;
    var aftersaveactionpath = string.Empty;
    var modalinputs = Model.GetModalFunctions();
}




<br />
<br />

@await Html.PartialAsync("_Modals")

@foreach (var mip in modalinputs)
{
    <div class="modal" id="addEditModal_@mip.ActionUserInterfaceMetaCode" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@mip.LocalizedTitle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="addEditModalBody_@mip.ActionUserInterfaceMetaCode">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="addEditModalSaveBtn_@mip.ActionUserInterfaceMetaCode" type="button" class="btn btn-sm btn-primary" data-dismiss="modal">@Localizer["Save"]</button>
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

}

<div id="app">



    <div class="card">
        <div class="card-header"><h2>@Model.LocalizedTitle</h2></div>
        <div class="card-body">

            <p>@Model.LocalizedDescription</p>

            <ul class="nav">
                @if (Model.HasCreateFunction)
                {
                    <li class="nav-item">
                        @if (Model.CreateFunction.IsModalAction)
                        {
                            <button class="nav-link btn btn-sm btn-outline-secondary" style="margin:10px" v-on:click="openApplicationModal(null, '@Model.CreateFunction.ActionUserInterfaceMetaCode')"><span class="fa fa-plus" style="font-size:large"></span> @Model.CreateFunction.LocalizedTitle</button>
                        }
                        else
                        {
                            <a href="@Model.CreateFunction.ActionPath" role="button" class="nav-link btn btn-sm btn-outline-secondary" style="margin:10px"><span class="fa fa-plus" style="font-size:large"></span> @Model.CreateFunction.LocalizedTitle</a>

                        }

                    </li>
                }

                @if (Model.HasNavigateFunction)
                {
                    <li class="nav-item">
                        <a href="@Model.NavigateFunction.ActionPath" role="button" class="nav-link btn btn-sm btn-outline-secondary" style="margin:10px"><span class="fa fa-plus" style="font-size:large"></span> @Model.NavigateFunction.LocalizedTitle</a>
                    </li>
                }

                @if (Model.HasExportFunction)
                {
                    <li class="nav-item">
                        <button class="nav-link btn btn-sm btn-outline-secondary" type="button" v-on:click="exportToExcel()" style="margin:10px"><span class="fa fa-file-export" style="color:seagreen; font-size:large"></span> @Model.ExportFunction.LocalizedTitle</button>
                    </li>
                }

                @if (Model.HasSaveFunction)
                {
                    <li class="nav-item">
                        <button class="nav-link btn btn-sm btn-outline-primary" type="button" v-on:click="saveApplication()" style="margin:10px"><span class="fa fa-save" style="font-size:large"></span> @Model.SaveFunction.LocalizedTitle</button>
                    </li>

                    aftersaveaction = Model.SaveFunction.GetPropertyValue("AFTERSAVEACTION");
                    if (aftersaveaction == "GOTOLISTVIEW")
                    {
                        aftersaveactionpath = Model.SaveFunction.GetPropertyValue("GOTOLISTVIEWPATH");
                    }
                }
            </ul>

        </div>
    </div>

    <br />

    @foreach (var iface in Model.UserInterface)
    {

        if (iface.IsMetaTypeInputInterface)
        {
            @foreach (var sect in iface.Sections)
            {

                var colapse = "class=\"collapse\"";
                var card = "class=\"card\"";
                var cardbody = "class=\"card-body\"";
                var accordion = "class=\"accordion\"";
                if (sect.StartExpanded || !sect.Collapsible)
                {
                    colapse = "class=\"collapse show\"";
                }
                @if (sect.ExcludeOnRender)
                {
                    colapse = "";
                    card = "";
                    cardbody = "";
                    accordion = "";

                }
                <div @Html.Raw(accordion) id="accordion_@sect.MetaCode">
                    <div @Html.Raw(card) id="cardheader_@sect.MetaCode">
                        @if (!sect.ExcludeOnRender)
                        {
                            <div class="card-header">
                                <ul class="nav">
                                    <li class="nav-item">
                                        @if (sect.Collapsible)
                                        {
                                            <button class="btn btn-sm btn-secondary" type="button" data-toggle="collapse" data-target="#colapse_@sect.MetaCode" style="margin-right:20px;margin-bottom:5px"><span class="fa fa-expand-alt"></span></button>
                                        }
                                    </li>
                                    <li class="nav-item">
                                        <h4>@sect.LocalizedTitle</h4>
                                    </li>
                                </ul>


                            </div>
                        }

                        <div id="colapse_@sect.MetaCode" @Html.Raw(colapse) data-parent="#accordion_@sect.MetaCode">
                            <div @Html.Raw(cardbody) id="cardbody_@sect.MetaCode">
                                <br />
                                <div class="row">
                                    @foreach (var pl in sect.LayoutPanels)
                                    {
                                        <div class="col-md-@(12/sect.LayoutPanels.Count)">

                                            @if (!string.IsNullOrEmpty(pl.LocalizedTitle))
                                            {
                                                @:<fieldset class="intwentypanel">
                                                    @:<legend>@pl.LocalizedTitle</legend>
                                                }

                                            @foreach (var t in pl.Controls)
                                            {
                                                if (t.IsUIContainerType)
                                                {
                                                    continue;
                                                }
                                                if (t.IsUIBindingType && (!t.IsDataColumn1Connected || !t.IsDataTableConnected))
                                                {
                                                    continue;
                                                }
                                               
                                                if (t.IsMetaTypeTextBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_TextBox", t)
                                                }

                                                if (t.IsMetaTypeNumBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_NumBox", t)

                                                }

                                                if (t.IsMetaTypeDatePicker)
                                                {
                                                    @await Html.PartialAsync("UIControls/_DatePicker", t)

                                                }

                                                if (t.IsMetaTypeCheckBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_CheckBox", t)

                                                }

                                                if (t.IsMetaTypeTextArea)
                                                {
                                                    @await Html.PartialAsync("UIControls/_TextArea", t)

                                                }

                                                if (t.IsMetaTypeComboBox && t.HasValueDomain)
                                                {
                                                    @await Html.PartialAsync("UIControls/_ComboBox", t)

                                                }

                                                if (t.IsMetaTypeImageBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_ImageBox", t)

                                                }

                                                if (t.IsMetaTypeImage)
                                                {
                                                    @await Html.PartialAsync("UIControls/_Image", t)

                                                }

                                                if (t.IsMetaTypeEmailBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_EmailBox", t)

                                                }

                                                //LOOKUP bound to DATAVIEW
                                                if (t.IsMetaTypeSearchBox)
                                                {
                                                    @await Html.PartialAsync("UIControls/_SearchBox", t)

                                                    <br />
                                                    <br />
                                                }

                                                if (t.IsMetaTypeLabel)
                                                {
                                                    @await Html.PartialAsync("UIControls/_Label", t)

                                                }

                                                if (t.IsMetaTypeTextBlock)
                                                {
                                                    @await Html.PartialAsync("UIControls/_TextBlock", t)

                                                }

                                             

                                            }  <!--FOR CONTROL -->


                                            @if (!string.IsNullOrEmpty(pl.LocalizedTitle))
                                            {
                                            @: </fieldset>
                                        }

                                        </div> <!--COL PANEL -->

                                    }

                                </div> <!--ROW SECTION-->
                            </div> <!--CARD-BODY -->
                        </div><!--COLAPSE -->
                    </div>  <!--CARD -->
                </div><!--ACCORDION -->


            } <!--SECTION-->

        } <!--INTERFACE-->

        if (iface.IsMetaTypeListInterface && iface.Table.Id > 0)
        {

            <br />

            @if (iface.HasFilterFunction)
            {

                <div class="row">

                    <div class="col-lg-7">

                        <button v-on:click="model.showFilter=!model.showFilter">
                            <i class="fas fa-search"></i>
                            <span v-if="model.showFilter">Hide Filter</span>
                            <span v-if="!model.showFilter">Show Filter</span>
                        </button>

                        <br />
                        <br />

                        <fieldset style="padding:5px; border:1px solid black; border-radius:4px" v-if="model.showFilter">

                            <div class="row">
                                <div class="col-lg-5"><button type="button" v-on:click="addFilterValue()"><span class="fa fa-plus"></span> Add filter</button></div>
                                <div class="col-lg-5"></div>
                                <div class="col-lg-2"></div>
                            </div>

                            <div class="mt-2"></div>

                            <div class="row" v-for="filteritem in pageInfo.filterValues">

                                <div class="col-lg-5">
                                    <div class="form-group">
                                        <select v-model="filteritem.name" class="form-control form-control-sm" placeholder="Filter">
                                            @{
                                                foreach (var c in iface.Table.Columns)
                                                {
                                                    <option value="@c.DataColumnDbName">@c.LocalizedTitle</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-5">
                                    <div class="form-group">
                                        <input type="text" class="form-control form-control-sm" v-model="filteritem.value" v-on:blur="runFilter()" placeholder="Value to filter on" />
                                    </div>
                                </div>

                                <div class="col-lg-2">
                                    <button type="button" class="btn btn-sm btn-danger" v-on:click="deleteFilterValue(filteritem)"><i class="fa fa-trash"></i></button>
                                </div>



                            </div>



                        </fieldset>

                    </div>
                    <div class="col-lg-5"></div>

                </div>


            }

            @if (iface.HasCreateFunction && Model.IsApplicationInputView())
            {
                @if (iface.CreateFunction.IsModalAction)
                {
                    <button class="nav-link btn btn-sm btn-outline-secondary" v-on:click="openSubTableModal(null,'@iface.CreateFunction.ActionUserInterfaceMetaCode')"><span class="fa fa-plus"></span> @iface.CreateFunction.LocalizedTitle</button>
                }
            }

            <table class="table table-responsive-sm">
                <thead>
                    <tr>
                        @if (iface.HasDeleteFunction)
                        {
                            <th style="width:5%"></th>
                        }
                        @if (iface.HasEditFunction)
                        {
                            <th style="width:5%"></th>
                        }

                        @{
                            foreach (var c in iface.Table.Columns)
                            {
                                <th v-on:click="sortBycolumn('@c.DataColumnDbName')" style="cursor:pointer">@c.LocalizedTitle <span class="fa fa-sort-alpha-down-alt"></span></th>

                            }
                        }
                    </tr>
                </thead>
                <tr v-for="item in sortedResults">
                    @if (iface.HasDeleteFunction)
                    {
                        <td style="vertical-align:middle"><button class="btn btn-sm btn-danger" v-on:click="deleteApplication(item)"><span class="fas fa-trash" title="Remove"></span></button></td>
                    }
                    @if (iface.HasEditFunction)
                    {
                        @if (iface.EditFunction.IsModalAction && Model.IsApplicationListView())
                        {
                            <td style="vertical-align:middle"><button class="btn btn-sm btn-secondary" v-on:click="openApplicationModal(item, '@iface.EditFunction.ActionUserInterfaceMetaCode')"><span class="fas fa-edit" title="Edit"></span></button></td>
                        }
                        else if (iface.EditFunction.IsModalAction && Model.IsApplicationInputView())
                        {
                            <td style="vertical-align:middle"><button class="btn btn-sm btn-secondary" v-on:click="openSubTableModal(item, '@iface.EditFunction.ActionUserInterfaceMetaCode')"><span class="fas fa-edit" title="Edit"></span></button></td>
                        }
                        else
                        {
                            <td style="vertical-align:middle"><a v-bind:href="'@iface.EditFunction.ActionPath/' + item.Id" class="btn btn-sm btn-secondary" role="button"><span class="fas fa-edit" title="Edit"></span></a></td>
                        }

                    }

                    @{
                        foreach (var c in iface.UIStructure.Where(p => !p.IsRoot))
                        {

                            if (c.IsMetaTypeImage)
                            {
                                <td>
                                    <img v-bind:src="item.@c.DataColumnDbName" width="80" class="rounded" />
                                </td>
                            }
                            else
                            {
                                <td>{{item.@c.DataColumnDbName}}</td>
                            }
                        }

                    }

                </tr>

            </table>

            @if (iface.HasPagingFunction)
            {
                <nav>
                    <ul class="pagination">
                        <li class="page-item" v-bind:class="{ disabled: isFirstPage }"><a class="page-link" href="#" v-on:click="prevpage()">Previous {{pageInfo.pageSize}}</a></li>
                        <li class="page-item" v-bind:class="{ disabled: isLastPage }"><a class="page-link" href="#" v-on:click="nextpage()">Next {{pageInfo.pageSize}}</a></li>
                    </ul>
                </nav>
            }
        }




    }




</div>

@section Scripts
{

    <script>

        var modalapps = [];

        var app = new Vue({
            el: '#app',
            data: {
                baseurl: '@Url.Content("~/Application/API/")'
                ,appMainTable: '@mainDbName'
                ,appId: @applicationId
                ,instanceId: @instanceid
                ,datalist: []
                ,model: { showFilter: false,  ['@mainDbName']: {} }
                ,pageInfo: { applicationId: @applicationId, applicationViewId: @applicationViewId, maxCount: 0, pageSize: 20, pageNumber: 0, filterValues: [] }
                ,currentSort: ''
                ,currentSortDir: 'asc'
                ,dataview: []
                ,valuedomains: {}
                ,validation: {}
                ,current_edit_line: {}
                ,dlgFilterColumnName: ""
                ,dlgFilterValue: ""
                ,applicationViewId: @applicationViewId
                ,aftersaveaction:'@aftersaveaction'
                ,aftersaveactionpath: '@aftersaveactionpath'
                ,showDataViewFilter: false


            },
            methods:
            {

                openApplicationModal: function (item, uimetacode)
                {
                    var context = this;
                    var endpointurl = context.baseurl + "GetModalInput/" + context.appId + "/" + uimetacode + "/" + context.instanceId;

                    var modalapp = null;
                    for (var i = 0; i < modalapps.length; i++) {
                        if (modalapps[i].name == uimetacode) {
                            modalapp = modalapps[i].app;
                            break;
                        }
                    }

                    var savefunc = function ()
                    {
                           var saveendpoint = context.baseurl + "Save";
                            modalapp.model[context.appMainTable].ApplicationId = context.appId;
                            modalapp.model[context.appMainTable].ApplicationViewId = context.applicationViewId;

                            $.ajax({
                                url: saveendpoint,
                                type: "POST",
                                contentType: "application/json",
                                data: JSON.stringify(modalapp.model),
                                success: function (response) {

                                }
                            });
                    };

                    if (modalapp == null)
                    {
                         //NEW MODAL APP CONFIG
                         var appconfig = {
                             template: '',
                             el: "#addEditModalBody_" + uimetacode
                             , data: {
                                 model: {
                                     ['@mainDbName']: {} }
                                ,dataview: []
                                ,valuedomains: {}
                                ,validation: {}
                                ,dlgFilterColumnName: ""
                                ,dlgFilterValue: ""
                            }
                        };

                        $.get(endpointurl, function (response)
                        {
                            //TEMPLATE
                            appconfig.template = response;

                            //NEW APP
                            modalapp = new Vue(appconfig);

                            modalapps.push({ name: uimetacode, app: modalapp });

                        }).done(function () {

                            if (item)
                            {
                                endpointurl = context.baseurl + "GetValueDomains/" + context.appId;
                                $.get(endpointurl, function (response) {
                                    modalapp.valuedomains = JSON.parse(response.data);

                                }).done(function ()
                                {
                                     modalapp.model.@mainDbName = item;
                                    $('#addEditModalSaveBtn_' + uimetacode).off('click', savefunc);
                                    $('#addEditModalSaveBtn_' + uimetacode).off().on('click', savefunc);
                                    $('#addEditModal_' + uimetacode).modal();
                                });
                            }
                            else
                            {
                                endpointurl = context.baseurl + "GetValueDomains/" + context.appId;
                                $.get(endpointurl, function (response) {
                                    modalapp.valuedomains = JSON.parse(response.data);

                                }).done(function () {

                                    endpointurl = context.baseurl + "CreateNew/" + context.appId;
                                    $.get(endpointurl, function (response) {
                                        modalapp.model = JSON.parse(response.data);
                                    });
                                }).done(function ()
                                {
                                    $('#addEditModalSaveBtn_' + uimetacode).off('click', savefunc);
                                    $('#addEditModalSaveBtn_' + uimetacode).off().on('click', savefunc);
                                    $('#addEditModal_' + uimetacode).modal();
                                });
                            }


                        });
                    }
                    else
                    {
                        if (item)
                         {
                                endpointurl = context.baseurl + "GetValueDomains/" + context.appId;
                                $.get(endpointurl, function (response) {
                                    modalapp.valuedomains = JSON.parse(response.data);

                                }).done(function ()
                                {
                                     modalapp.model.@mainDbName = item;
                                    $('#addEditModalSaveBtn_' + uimetacode).off('click', savefunc);
                                    $('#addEditModalSaveBtn_' + uimetacode).off().on('click', savefunc);
                                    $('#addEditModal_' + uimetacode).modal();
                                });
                         }
                         else
                         {
                                endpointurl = context.baseurl + "GetValueDomains/" + context.appId;
                                $.get(endpointurl, function (response) {
                                    modalapp.valuedomains = JSON.parse(response.data);

                                }).done(function () {

                                    endpointurl = context.baseurl + "CreateNew/" + context.appId;
                                    $.get(endpointurl, function (response) {
                                        modalapp.model = JSON.parse(response.data);
                                    });
                                }).done(function ()
                                {
                                    $('#addEditModalSaveBtn_' + uimetacode).off('click', savefunc);
                                    $('#addEditModalSaveBtn_' + uimetacode).off().on('click', savefunc);
                                    $('#addEditModal_' + uimetacode).modal();
                                });
                        }
                    }
                },
                openSubTableModal: function (item, uimetacode) {
                    raiseInformationModal('Not implemented yet', uimetacode);
                },
                saveApplication: function () {
                    var context = this;
                    var endpointurl = context.baseurl + "Save";

                    context.model[context.appMainTable].ApplicationId = context.appId;
                    context.model[context.appMainTable].ApplicationViewId = context.applicationViewId;

                    if (!context.canSave())
                        return;

                    $.ajax({
                        url: endpointurl,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(this.model),
                        success: function (response) {
                            if (response.isSuccess)
                            {
                                if (context.aftersaveaction == 'GOTOLISTVIEW' && context.aftersaveactionpath != '')
                                {
                                   endpointurl = '@Url.Content("~/" + aftersaveactionpath)';
                                   window.location.href = endpointurl;
                                }
                                else if (context.aftersaveaction == 'REFRESH')
                                {
                                    window.location.reload(true);
                                }

                            }
                            else {
                                raiseErrorModal(response);
                            }
                        }
                    });
                },
                onImageChanged: function (event)
                {
                    this.uploadImage(event);
                },
                getPage: function ()
                {
                    var context = this;
                    var endpointurl = context.baseurl + "GetPagedList";

                    this.pageInfo.applicationViewId = context.applicationViewId;

                    $.ajax({
                        url: endpointurl,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(this.pageInfo),
                        success: function (response) {
                            //DATA
                            context.datalist = JSON.parse(response.data);

                            //UPDATE CURRENT PAGE INFO
                            context.pageInfo = response.listFilter;
                            if (context.pageInfo.filterValues.length === 0)
                                context.addFilterValue();
                        }
                    });
                },
                sortBycolumn: function (s) {
                    //if s == current sort, reverse
                    if (s === this.currentSort) {
                        this.currentSortDir = this.currentSortDir === 'asc' ? 'desc' : 'asc';
                    }
                    this.currentSort = s;
                },
                exportToExcel: function ()
                {
                    var context = this;
                    var args =  { applicationId: @applicationId, applicationViewId: @applicationViewId, maxCount: 0, pageSize: 20000, pageNumber: 0, filterValues: [], skipPaging:true }
                    var endpointurl = context.baseurl + "GetPagedList";

                    $.ajax({
                        url: endpointurl,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(args),
                        success: function (response) {
                            var data = JSON.parse(response.data);
                            alasql.promise('SELECT * INTO XLSX("download.xlsx",{headers:true}) FROM ?', [data])
                                .then(function (data) {
                                    console.log('Data saved');
                                }).catch(function (err) {
                                    console.log('Error:', err);
                                });
                        }
                    });
                },
                deleteApplication: function (item) {
                    var context = this;
                    var endpointurl = context.baseurl + "Delete";

                    var deleteapp = function ()
                    {
                        item.ApplicationId = context.appId;
                        item.ApplicationViewId = context.applicationViewId;

                        $.ajax({
                            url: endpointurl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(item),
                            success: function (response) {

                                if (response.isSuccess) {
                                    window.location.reload(true);
                                }
                                else {
                                    raiseErrorModal(response);
                                }
                            }
                        });
                    };

                    raiseYesNoModal("Delete ?", "This record will be deleted, are you sure ?", deleteapp);
                },
                initSelectizeControls: function ()
                {
                    var context = this;

                   
                  
                }
            },
            computed: {

                sortedResults: function () {
                    return this.datalist.sort((a, b) => {
                        let modifier = 1;
                        if (this.currentSortDir === 'desc') modifier = -1;
                        if (a[this.currentSort] < b[this.currentSort]) return -1 * modifier;
                        if (a[this.currentSort] > b[this.currentSort]) return 1 * modifier;
                        return 0;
                    });
                },
                isFirstPage: function () {
                    return (this.pageInfo.pageNumber <= 0);
                },
                isLastPage: function () {
                    return ((this.pageInfo.pageNumber + 1) * this.pageInfo.pageSize) >= this.pageInfo.maxCount;
                }
            },
            mounted: function () {
                var context = this;
                @if (Model.IsApplicationListView())
                {
                    <text>context.getPage();</text>
                }
                else if (Model.IsApplicationInputView() && instanceid > 0)
                {
                    <text>
                    var endpointurl = context.baseurl + "GetApplication/" + context.appId + "/" + context.applicationViewId + "/" + context.instanceId;
                    $.get(endpointurl, function (response) {
                        context.model = JSON.parse(response.data);
                    });
                    </text>
              }
              else if (Model.IsApplicationInputView() && instanceid == 0)
              {
                    <text>
                   
                        var endpointurl = context.baseurl + "CreateNew/" + context.appId;
                        $.get(endpointurl, function (response)
                        {
                            context.model = JSON.parse(response.data);
                        });
               
                    </text>

              }

            }
        });


    </script>

}
